{"__ud_title":"ä½¿ç”¨Relayrä»£ç†åè®®URL","__ud_tags":["Cent"],"__ud_update_time":1769768927733,"__ud_create_time":1769765697962,"__ud_draft":false,"type":"doc","content":[{"type":"heading","attrs":{"level":1,"id":"ä½¿ç”¨Relayrä»£ç†åè®®URL"},"content":[{"type":"text","text":"ä½¿ç”¨Relayrä»£ç†åè®®URL"}]},{"type":"paragraph","content":[{"type":"text","text":"åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°è·¨åŸŸã€éœ€è¦åŠ¨æ€æ›´æ¢ API ä»£ç†æˆ–æ˜¯åœ¨è¯·æ±‚å¤´ä¸­æ³¨å…¥é‰´æƒä¿¡æ¯çš„éœ€æ±‚ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§é€šè¿‡ "},{"type":"text","marks":[{"type":"bold"}],"text":"Fetch åŠ«æŒ"},{"type":"text","text":" ç»“åˆ "},{"type":"text","marks":[{"type":"bold"}],"text":"è‡ªå®šä¹‰ä¼ªåè®®"},{"type":"text","text":" çš„æ–¹æ¡ˆï¼Œå®ç°ä¸€å¥—ä¼˜é›…ä¸”çµæ´»çš„ä»£ç†ä¸­é—´ä»¶ã€‚"}]},{"type":"blockquote","content":[{"type":"paragraph","content":[{"type":"text","text":"åœ¨Centä¸­ï¼Œæ‰€æœ‰å…è®¸è¾“å…¥è‡ªå®šä¹‰URLçš„åœ°æ–¹éƒ½æ”¯æŒRelayråè®®è‡ªå®šä¹‰ä»£ç†ï¼Œä½†æ˜¯ä½ éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªæ”¯æŒè¯¥åè®®çš„åç«¯æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡Cloudflare Workersæˆ–è€…Supabase Edge Functionéƒ¨ç½²ã€‚"}]}]},{"type":"heading","attrs":{"level":2,"id":"1-åè®®è®¾è®¡"},"content":[{"type":"text","text":"1. åè®®è®¾è®¡"}]},{"type":"paragraph","content":[{"type":"text","text":"ä¼ ç»Ÿçš„ URL ä¼ å‚å®¹æ˜“å—åˆ°ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ JSON ä¸­çš„å¼•å·ã€å¤§æ‹¬å·ï¼‰çš„å½±å“ï¼Œå¯¼è‡´è§£æå¤±è´¥ã€‚æˆ‘ä»¬é‡‡ç”¨ "},{"type":"text","marks":[{"type":"bold"}],"text":"Base64 ç¼–ç é…ç½®"},{"type":"text","text":" çš„æ–¹æ¡ˆï¼š"}]},{"type":"heading","attrs":{"level":3,"id":"åè®®æ ¼å¼"},"content":[{"type":"text","text":"åè®®æ ¼å¼"}]},{"type":"paragraph","content":[{"type":"text","marks":[{"type":"code"}],"text":"proxy://<base64_config>@<target_path_suffix>"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"code"}],"text":"proxy://"},{"type":"text","text":": åè®®å¤´ï¼Œç”¨äºä¸­é—´ä»¶è¯†åˆ«ã€‚"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"code"}],"text":"<base64_config>"},{"type":"text","text":": åŒ…å«ä»£ç†æœåŠ¡å™¨åœ°å€ã€ç›®æ ‡åŸºå‡†åœ°å€ã€é¢å¤– Header çš„ JSON å¯¹è±¡ï¼Œå¹¶ç»è¿‡ Base64 ç¼–ç ã€‚"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"code"}],"text":"@"},{"type":"text","text":": åˆ†éš”ç¬¦ã€‚"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"code"}],"text":"<target_path_suffix>"},{"type":"text","text":": å…·ä½“çš„ API è·¯å¾„åç¼€ã€‚"}]}]}]},{"type":"heading","attrs":{"level":3,"id":"æ•°æ®ç»“æ„ç¤ºä¾‹"},"content":[{"type":"text","text":"æ•°æ®ç»“æ„ç¤ºä¾‹"}]},{"type":"paragraph","content":[{"type":"text","text":"ç¼–ç å‰çš„ JSON é…ç½®ï¼š"}]},{"type":"paragraph","content":[{"type":"text","text":"JSON"}]},{"type":"codeBlock","attrs":{"language":"json"},"content":[{"type":"text","text":"{\n  \"proxyUrl\": \"https://my-server.com/proxy\",\n  \"targetBase\": \"https://api.openai.com\",\n  \"headers\": {\n    \"x-proxy-key\": \"Bearer sk-123\"\n  }\n}\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"2-å‰ç«¯ä¸­é—´ä»¶å®ç°"},"content":[{"type":"text","text":"2. å‰ç«¯ä¸­é—´ä»¶å®ç°"}]},{"type":"paragraph","content":[{"type":"text","text":"åŸºäºä½ å·²æœ‰çš„ "},{"type":"text","marks":[{"type":"code"}],"text":"registerProxy"},{"type":"text","text":" åŠ«æŒæ¡†æ¶ï¼Œæˆ‘ä»¬ç¼–å†™å¦‚ä¸‹è§£æé€»è¾‘ï¼š"}]},{"type":"paragraph","content":[{"type":"text","text":"TypeScript"}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"const proxyMiddleware: Handler = async (url, options, next) => {\n    const urlStr = url.toString();\n\n    // 1. è¯†åˆ«åè®®\n    if (!urlStr.startsWith('proxy://')) {\n        return next(url, options);\n    }\n\n    try {\n        // 2. æ‹†åˆ† Base64 é…ç½®ä¸è·¯å¾„åç¼€\n        const mainPart = urlStr.slice(8); // ç§»é™¤ 'proxy://'\n        const [configBase64, ...pathParts] = mainPart.split('@');\n        const targetPathSuffix = pathParts.join('@'); // é˜²æ­¢è·¯å¾„ä¸­ä¹Ÿå¸¦æœ‰ @\n\n        // 3. è§£ç å¹¶è§£æé…ç½®\n        const configJson = JSON.parse(atob(configBase64));\n        const { proxyUrl, targetBase, headers: extraHeaders } = configJson;\n\n        // æ‹¼æ¥æœ€ç»ˆç›®æ ‡åœ°å€\n        const finalTargetUrl = `${targetBase}${targetPathSuffix}`;\n\n        // 4. è½¬æ¢è¯·æ±‚å‚æ•°\n        const newOptions: RequestInit = {\n            ...options,\n            method: 'POST', // ä»£ç†è¯·æ±‚ç»Ÿä¸€è½¬ä¸º POST ä»¥ä¾¿åœ¨ Body ä¸­æºå¸¦ target\n            headers: {\n                ...options.headers,\n                ...extraHeaders,\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                target: finalTargetUrl,\n                payload: options.body ? \n                         (typeof options.body === 'string' ? JSON.parse(options.body) : options.body) \n                         : null\n            })\n        };\n\n        console.log(`[Proxy] Forwarding to: ${finalTargetUrl}`);\n        return next(proxyUrl, newOptions);\n    } catch (err) {\n        console.error(\"[Proxy Error]\", err);\n        return next(url, options);\n    }\n};\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"3-ä»£ç†åç«¯å®ç°-Nodejs-ç¤ºä¾‹"},"content":[{"type":"text","text":"3. ä»£ç†åç«¯å®ç° (Node.js ç¤ºä¾‹)"}]},{"type":"paragraph","content":[{"type":"text","text":"åç«¯ä»£ç†æœåŠ¡å™¨éœ€è¦æ¥æ”¶ "},{"type":"text","marks":[{"type":"code"}],"text":"POST"},{"type":"text","text":" è¯·æ±‚ï¼Œè§£æå…¶ä¸­çš„ "},{"type":"text","marks":[{"type":"code"}],"text":"target"},{"type":"text","text":" å­—æ®µï¼Œå¹¶æºå¸¦è¯·æ±‚å¤´è½¬å‘ã€‚"}]},{"type":"paragraph","content":[{"type":"text","text":"JavaScript"}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"const express = require('express');\nconst axios = require('axios');\nconst app = express();\n\napp.use(express.json());\n\napp.post('/proxy', async (req, res) => {\n    const { target, payload } = req.body;\n    \n    // è·å–å‰ç«¯æ³¨å…¥çš„é¢å¤– Header (ä¾‹å¦‚ x-proxy-key)\n    const proxyHeaders = { ...req.headers };\n    // ç§»é™¤å®¿ä¸»ä¿¡æ¯ï¼Œé˜²æ­¢ç›®æ ‡æœåŠ¡å™¨æ ¡éªŒå¤±è´¥\n    delete proxyHeaders.host; \n\n    try {\n        console.log(`Forwarding request to: ${target}`);\n        \n        const response = await axios({\n            method: 'POST', // æˆ–æ ¹æ®é€»è¾‘é€ä¼ åŸ method\n            url: target,\n            data: payload,\n            headers: proxyHeaders,\n            timeout: 10000\n        });\n\n        res.status(response.status).send(response.data);\n    } catch (error) {\n        const status = error.response ? error.response.status : 500;\n        res.status(status).send(error.message);\n    }\n});\n\napp.listen(3000, () => console.log('Proxy Server running on port 3000'));\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"4-å¦‚ä½•ä½¿ç”¨"},"content":[{"type":"text","text":"4. å¦‚ä½•ä½¿ç”¨"}]},{"type":"paragraph","content":[{"type":"text","text":"åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å·¥å…·å‡½æ•°ç”Ÿæˆè¿™ä¸ªå¤åˆ URLï¼š"}]},{"type":"heading","attrs":{"level":3,"id":"ç”Ÿæˆå™¨å·¥å…·"},"content":[{"type":"text","text":"ç”Ÿæˆå™¨å·¥å…·"}]},{"type":"paragraph","content":[{"type":"text","text":"JavaScript"}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"function createProxyUrl(config, apiPath) {\n    const base64 = btoa(JSON.stringify(config));\n    return `proxy://${base64}@${apiPath}`;\n}\n"}]},{"type":"heading","attrs":{"level":3,"id":"å‘èµ·è¯·æ±‚"},"content":[{"type":"text","text":"å‘èµ·è¯·æ±‚"}]},{"type":"paragraph","content":[{"type":"text","text":"JavaScript"}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"const config = {\n    proxyUrl: \"http://localhost:3000/proxy\",\n    targetBase: \"https://api.openai.com\",\n    headers: { \"Authorization\": \"Bearer TOKEN\" }\n};\n\n// å®é™…è¯·æ±‚åœ°å€ï¼šproxy://ey...@{config}@/v1/chat/completions\nfetch(createProxyUrl(config, '/v1/chat/completions'), {\n    method: 'POST',\n    body: JSON.stringify({ model: 'gpt-3.5-turbo' })\n});\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"5-æ€»ç»“"},"content":[{"type":"text","text":"5. æ€»ç»“"}]},{"type":"paragraph","content":[{"type":"text","text":"è¯¥æ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºï¼š"}]},{"type":"orderedList","attrs":{"start":1,"type":null},"content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"é«˜åº¦å°è£…"},{"type":"text","text":"ï¼šä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒä»£ç†æœåŠ¡å™¨çš„å…·ä½“å®ç°ã€‚"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"å…¼å®¹æ€§å¼º"},{"type":"text","text":"ï¼šBase64 é¿å…äº† URL ç‰¹æ®Šå­—ç¬¦å¸¦æ¥çš„è§£æå™©æ¢¦ã€‚"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"åŠ¨æ€æ€§"},{"type":"text","text":"ï¼šå¯ä»¥éšæ—¶åœ¨å‰ç«¯é€šè¿‡ä¿®æ”¹ "},{"type":"text","marks":[{"type":"code"}],"text":"config"},{"type":"text","text":" æ¥åˆ‡æ¢ä¸åŒçš„ä»£ç†èŠ‚ç‚¹æˆ–ç›®æ ‡ APIã€‚"}]}]}]},{"type":"blockquote","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"æ³¨æ„"},{"type":"text","text":"ï¼šç”±äº Base64 ç¼–ç ä¼šå¢åŠ å­—ç¬¦ä¸²ä½“ç§¯ï¼Œä¸” URL é•¿åº¦åœ¨ä¸åŒæµè§ˆå™¨ä¸­æœ‰é™åˆ¶ï¼ˆå¦‚ Chrome é™åˆ¶ä¸º 2MBï¼‰ï¼Œæœ¬æ–¹æ¡ˆé€‚ç”¨äºé…ç½®ä¿¡æ¯ä¸­ç­‰çš„åœºæ™¯ã€‚"}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":null},"content":[{"type":"text","text":"Demo"}]},{"type":"codeBlock","attrs":{"language":"html"},"content":[{"type":"text","text":"<!-- reactive -->\n    <style>\n        body { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Helvetica, Arial, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #333; }\n        .card { border: 1px solid #e1e4e8; padding: 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(149,157,165,0.1); background: white; }\n        h2 { margin-top: 0; color: #0366d6; font-size: 1.5rem; }\n        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9rem; color: #586069; }\n        input, textarea { width: 100%; padding: 10px; margin-top: 6px; box-sizing: border-box; border: 1px solid #d1d5da; border-radius: 6px; font-size: 14px; background: #fafbfc; transition: border 0.2s; }\n        input:focus, textarea:focus { border-color: #0366d6; outline: none; background: white; box-shadow: 0 0 0 3px rgba(3,102,214,0.1); }\n        button { background: #2ea44f; color: white; border: 1px solid rgba(27,31,35,0.15); padding: 12px; border-radius: 6px; cursor: pointer; margin-top: 24px; width: 100%; font-weight: 600; font-size: 16px; transition: background 0.2s; }\n        button:hover { background: #2c974b; }\n        \n        #result-container { margin-top: 24px; display: none; animation: fadeIn 0.3s ease; }\n        .result-box { \n            background: #f6f8fa; \n            padding: 15px; \n            word-break: break-all; \n            border: 1px dashed #0366d6; \n            border-radius: 6px; \n            font-family: \"SFMono-Regular\", Consolas, \"Liberation Mono\", Menlo, monospace; \n            font-size: 13px;\n            cursor: pointer;\n            position: relative;\n            transition: background 0.2s;\n        }\n        .result-box:hover { background: #f0f3f6; }\n        .result-box::after { content: \"ç‚¹å‡»å¤åˆ¶\"; position: absolute; right: 8px; top: 4px; font-size: 10px; color: #0366d6; font-weight: bold; opacity: 0.7; }\n        \n        .copy-tip { color: #28a745; font-size: 12px; font-weight: bold; margin-top: 8px; display: none; text-align: center; }\n        \n        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n    </style>\n\n<div class=\"card\">\n    <h2>ğŸ”— Proxy åè®®ç”Ÿæˆå™¨</h2>\n    \n    <label>ä»£ç†æœåŠ¡å™¨åœ°å€ (Proxy URL)</label>\n    <input type=\"text\" id=\"proxyUrl\" placeholder=\"https://my-server.com/proxy\" value=\"https://my-server.com/proxy\">\n\n    <label>ç›®æ ‡ API æ ¹è·¯å¾„ (Target Base)</label>\n    <input type=\"text\" id=\"targetBase\" placeholder=\"https://openai.com/api\" value=\"https://openai.com/api\">\n\n    <label>è‡ªå®šä¹‰ Header (JSON)</label>\n    <textarea id=\"headers\" rows=\"3\">{\"x-proxy-key\": \"Bearer sk-123456\"}</textarea>\n\n    <button onclick=\"generateLink()\">ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥</button>\n\n    <div id=\"result-container\">\n        <label>ç”Ÿæˆçš„ä¼ªåè®®å‰ç¼€ (ç‚¹å‡»ä¸‹æ–¹æ–¹æ¡†è‡ªåŠ¨å¤åˆ¶):</label>\n        <div class=\"result-box\" id=\"output\" onclick=\"copyToClipboard()\"></div>\n        <div id=\"copyTip\" class=\"copy-tip\">âœ… å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼</div>\n        <p style=\"font-size: 12px; color: #6a737d; margin-top: 12px;\">\n            ğŸ’¡ æç¤ºï¼šåœ¨ä»£ç ä¸­è°ƒç”¨æ—¶ï¼Œç›´æ¥æ‹¼æ¥å…·ä½“è·¯å¾„ï¼Œä¾‹å¦‚ï¼š<br>\n            <code>fetch(prefix + '/v1/chat/completions')</code>\n        </p>\n    </div>\n</div>\n\n<script>\n    function generateLink() {\n        const proxyUrl = document.getElementById('proxyUrl').value;\n        const targetBase = document.getElementById('targetBase').value;\n        const headersStr = document.getElementById('headers').value;\n\n        try {\n            // æ ¡éªŒ JSON æ ¼å¼\n            const headers = JSON.parse(headersStr);\n            const config = { proxyUrl, targetBase, headers };\n\n            // å®‰å…¨çš„ UTF-8 Base64 ç¼–ç é€»è¾‘\n            const jsonStr = JSON.stringify(config);\n            const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => {\n                return String.fromCharCode('0x' + p1);\n            }));\n\n            const finalUrl = `proxy://${base64}@`;\n            \n            // æ˜¾ç¤ºç»“æœ\n            const output = document.getElementById('output');\n            output.innerText = finalUrl;\n            document.getElementById('result-container').style.display = 'block';\n            \n            // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡å¤åˆ¶\n            copyToClipboard(false); \n        } catch (e) {\n            alert(\"âŒ é”™è¯¯ï¼šJSON æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ Header å­—æ®µï¼\");\n        }\n    }\n\n    async function copyToClipboard(showVisualFeedback = true) {\n        const text = document.getElementById('output').innerText;\n        if (!text) return;\n\n        try {\n            await navigator.clipboard.writeText(text);\n            \n            if (showVisualFeedback) {\n                const tip = document.getElementById('copyTip');\n                tip.style.display = 'block';\n                setTimeout(() => {\n                    tip.style.display = 'none';\n                }, 2000);\n            }\n        } catch (err) {\n            // é™çº§å¤„ç†\n            const textArea = document.createElement(\"textarea\");\n            textArea.value = text;\n            document.body.appendChild(textArea);\n            textArea.select();\n            document.execCommand('copy');\n            document.body.removeChild(textArea);\n        }\n    }\n</script>"}]}]}